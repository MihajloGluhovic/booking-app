<div class="receipt-container" *ngIf="receipt; else loadingTemplate">
  <mat-card class="receipt-card">
    <mat-card-header>
      <div mat-card-avatar class="header-avatar">
        <img [src]="receipt.image" alt="Room Image" />
      </div>
      <mat-card-title>{{ receipt.roomTitle }}</mat-card-title>
      <mat-card-subtitle>Room Number: {{ receipt.roomNum }}</mat-card-subtitle>
    </mat-card-header>

    <mat-card-content>
      <div class="details">
        <p><strong>Description:</strong> {{ receipt.description }}</p>
        <p>
          <strong>Start Date:</strong>
          {{ receipt.startDate | date : "mediumDate" }}
        </p>
        <p>
          <strong>End Date:</strong> {{ receipt.endDate | date : "mediumDate" }}
        </p>
        <p><strong>Number of People:</strong> {{ receipt.numOfPeople }}</p>
        <p>
          <strong>Price Per Night:</strong>
          {{ receipt.pricePerNight | currency }}
        </p>
        <p><strong>Total Price:</strong> {{ receipt.totalPrice | currency }}</p>
        <p><strong>Features:</strong></p>
        <ul>
          <li *ngFor="let feature of features">
            {{ feature.name }} - {{ feature.price | currency }}
          </li>
        </ul>
        <p *ngIf="receipt.isExpired" class="expired">Booking Expired</p>
      </div>

      <!-- Review Form -->
      <mat-card *ngIf="!receipt.reviewExists">
        <form [formGroup]="reviewForm" (ngSubmit)="submitReview()">
          <h3>Rate our services</h3>

          <!-- Star Rating -->
          <div class="star-rating">
            <button
              [ngClass]="{ active: i < rating }"
              [color]="i < rating ? 'primary' : 'accent'"
              mat-icon-button
              *ngFor="let ratingId of ratingArr; index as i"
              [color]="i < rating ? 'primary' : 'accent'"
              [id]="'star_' + i"
              (click)="onStarClick(i + 1, $event)"
              [matTooltip]="i + 1 + ' stars'"
              matTooltipPosition="above"
              class="star-button"
            >
              <mat-icon>{{ showIcon(i) }}</mat-icon>
            </button>
          </div>

          <!-- Textarea for comments -->
          <mat-form-field appearance="outline" class="full-width">
            <mat-label>Leave a comment</mat-label>
            <textarea matInput formControlName="comment" rows="4"></textarea>
          </mat-form-field>

          <!-- Submit Button -->
          <button
            mat-raised-button
            color="primary"
            type="submit"
            [disabled]="!reviewForm.valid"
          >
            Submit Review
          </button>
        </form>
      </mat-card>
      <mat-card *ngIf="receipt.reviewExists" class="review-card">
        <!-- Show Review if Not Editing -->
        <ng-container *ngIf="!isEditing">
          <mat-card-header>
            <!-- Rating on the Right -->
            <mat-card-title class="rating">
              {{ receipt.review.rating }} / 5
              <mat-icon class="star">star</mat-icon>
            </mat-card-title>
          </mat-card-header>

          <!-- Comment Section -->
          <mat-card-content class="comment">
            <p>{{ receipt.review.comment }}</p>
          </mat-card-content>

          <!-- Footer Section -->
          <mat-card-footer>
            <mat-card-subtitle class="review-date">
              {{ receipt.review.createdAt | date : "mediumDate" }}
            </mat-card-subtitle>
            <div class="actions">
              <!-- Edit Button -->
              <button mat-button color="primary" (click)="editReview()">
                Edit
              </button>

              <!-- Delete Button -->
              <button mat-button color="warn" (click)="deleteReview()">
                Delete Review
              </button>
            </div>
          </mat-card-footer>
        </ng-container>

        <!-- Edit Review Section -->
        <div *ngIf="isEditing" class="edit-review">
          <form [formGroup]="editReviewForm" (ngSubmit)="submitEditedReview()">
            <!-- Star Rating -->
            <div class="star-rating">
              <button
                [ngClass]="{ active: i < editRating }"
                mat-icon-button
                *ngFor="let ratingId of ratingArr; index as i"
                (click)="onEditStarClick(i + 1, $event)"
                [matTooltip]="i + 1 + ' stars'"
                matTooltipPosition="above"
              >
                <mat-icon>{{ showEditIcon(i) }}</mat-icon>
              </button>
            </div>

            <!-- Textarea for comments -->
            <mat-form-field appearance="outline" class="full-width">
              <mat-label>Edit your comment</mat-label>
              <textarea matInput formControlName="comment" rows="4"></textarea>
            </mat-form-field>

            <div class="buttons">
              <!-- Save Button -->
              <button
                mat-raised-button
                color="primary"
                type="submit"
                [disabled]="!editReviewForm.valid"
              >
                Save Changes
              </button>

              <!-- Cancel Button -->
              <button
                mat-button
                color="warn"
                type="button"
                (click)="cancelEdit()"
              >
                Cancel
              </button>
            </div>
          </form>
        </div>
      </mat-card>
    </mat-card-content>
  </mat-card>
</div>

<ng-template #loadingTemplate>
  <div class="loading-spinner">
    <mat-spinner></mat-spinner>
    <p>Loading Receipt...</p>
  </div>
</ng-template>
